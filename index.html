<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Phát triển Cá nhân</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* --- General UI Refinements --- */
        .app-module-container { background-color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); min-height: 300px; }
        .empty-state-message { text-align: center; color: #6b7280; padding: 2rem 0; font-style: italic; }
        .list-item-hover:hover { background-color: #f9fafb; }
        .action-button-icon { padding: 0.3rem; margin-left: 0.5rem; border-radius: 9999px; transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out; display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; }
        .action-button-icon svg { width: 16px; height: 16px; }
        .action-button-icon:hover { background-color: rgba(0, 0, 0, 0.05); }
        .edit-icon-btn { color: #2563eb; } .delete-icon-btn { color: #dc2626; } .complete-icon-btn { color: #16a34a; } .undo-icon-btn { color: #ca8a04; } .save-icon-btn { color: #16a34a; } .cancel-icon-btn { color: #4b5563; }
        .pin-icon-btn { color: #6366f1; } .pin-icon-btn.pinned { color: #4f46e5; background-color: #e0e7ff; }
        .history-icon-btn { color: #6b7280; /* gray-500 */ } /* History button color */

        .nav-link { padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out; cursor: pointer; font-weight: 500; border: 1px solid transparent; }
        .nav-link:hover { background-color: rgba(255, 255, 255, 0.1); color: #e0f2fe; }
        .nav-link.active { background-color: white; color: #2563eb; font-weight: 600; border-color: #d1d5db; }
        .pin-indicator { position: absolute; top: 6px; left: 6px; opacity: 0.6; }
        .pin-indicator svg { width: 12px; height: 12px; }

        /* --- Notes Specific --- */
        .note-item { background-color: #fefce8; padding: 0.75rem; border-radius: 0.375rem; border: 1px solid #fef9c3; transition: background-color 0.15s ease-in-out; position: relative; }
        .note-item.pinned { background-color: #fef9c3; border-left: 3px solid #facc15; }
        .note-item .pin-indicator { color: #a16207; }
        .note-content, .edit-textarea { white-space: pre-wrap; word-break: break-word; }
        .edit-textarea { min-height: 60px; }
        .note-timestamp { font-size: 0.75rem; color: #a16207; margin-top: 0.5rem; }

        /* --- Goals Specific --- */
        .goal-item { display: flex; flex-direction: column; padding: 1rem; border-radius: 0.375rem; background-color: #f3f4f6; margin-bottom: 0.75rem; border: 1px solid #e5e7eb; transition: background-color 0.15s ease-in-out; position: relative; }
        .goal-item.pinned { background-color: #eef2ff; border-left: 3px solid #6366f1; }
        .goal-item .pin-indicator { color: #4f46e5; }
        .goal-item.completed { background-color: #e5e7eb; }
        .goal-item.editing { background-color: #f0f9ff; border-color: #bfdbfe; }
        .goal-header { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; margin-bottom: 0.5rem; }
        .goal-name { flex-grow: 1; margin-right: 0.5rem; font-weight: 600; }
        .goal-item.completed .goal-name { text-decoration: line-through; color: #6b7280; font-weight: 500; }
        .goal-details { width: 100%; font-size: 0.875rem; color: #4b5563; margin-top: 0.25rem; }
        .goal-description { margin-bottom: 0.25rem; white-space: pre-wrap; word-break: break-word; }
        .goal-due-date-info { display: flex; justify-content: space-between; align-items: baseline; margin-top: 0.3rem; padding: 0.25rem 0.5rem; border-radius: 0.25rem; background-color: rgba(0, 0, 0, 0.02); }
        .goal-due-date { font-style: italic; font-weight: 500; }
        .goal-days-remaining { font-weight: 600; font-size: 0.8rem; }
        .due-soon { color: #ca8a04; background-color: #fefce8; border-left: 3px solid #facc15; }
        .overdue { color: #b91c1c; background-color: #fee2e2; border-left: 3px solid #ef4444; }
        .on-track { color: #15803d; background-color: #f0fdf4; border-left: 3px solid #4ade80; }
        .goal-edit-area textarea, .goal-edit-area input[type="date"], .goal-edit-area input[type="text"] { width: 100%; padding: 0.25rem 0.5rem; border: 1px solid #d1d5db; border-radius: 0.25rem; margin-bottom: 0.5rem; font-size: 0.875rem; }

        /* --- Habits Specific --- */
        .habit-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; border-radius: 0.375rem; background-color: #f3f4f6; margin-bottom: 0.5rem; border: 1px solid #e5e7eb; }
        .habit-info { display: flex; align-items: baseline; flex-grow: 1; margin-right: 1rem; } /* Container for name and streak */
        .habit-name { font-weight: 500; }
        .habit-streak { /* Style for streak counter */
            font-size: 0.75rem; /* text-xs */
            font-weight: 600; /* semibold */
            color: #fb923c; /* text-orange-500 */
            background-color: #fff7ed; /* bg-orange-50 */
            padding: 0.1rem 0.4rem;
            border-radius: 9999px; /* rounded-full */
            margin-left: 0.5rem; /* ml-2 */
            display: inline-flex; /* Ensure it fits inline */
            align-items: center;
        }
         .habit-streak svg { /* Style for fire icon */
             width: 10px;
             height: 10px;
             margin-right: 0.15rem;
             color: #f97316; /* text-orange-600 */
         }
        .habit-checkbox-label { display: inline-flex; align-items: center; justify-content: center; width: 36px; height: 36px; border: 2px solid #d1d5db; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out; margin-right: 0.75rem; }
        .habit-checkbox-label:hover { border-color: #9ca3af; }
        .habit-checkbox-label.checked { background-color: #10b981; border-color: #059669; }
        .habit-checkbox-label.checked svg { color: white; width: 20px; height: 20px; }
        .habit-checkbox { display: none; }

    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">

    <header class="bg-blue-600 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">Ứng dụng Cá nhân</h1>
            <nav id="main-nav">
                <ul class="flex space-x-2">
                    <li><a href="#" id="nav-notes" class="nav-link" data-module="notes">Ghi chú</a></li>
                    <li><a href="#" id="nav-goals" class="nav-link" data-module="goals">Mục tiêu</a></li>
                    <li><a href="#" id="nav-habits" class="nav-link" data-module="habits">Thói quen</a></li> </ul>
            </nav>
        </div>
    </header>

    <main class="container mx-auto p-4 mt-4">
        <div id="app-content" class="app-module-container">
            <p class="empty-state-message">Đang tải...</p>
        </div>
    </main>

    <footer class="text-center text-gray-500 mt-8 p-4">
        <p>&copy; 2025 - Tạo bởi Bạn & Gemini</p>
    </footer>

    <script>
        // --- Global State and Elements ---
        let currentModule = 'notes';
        const appContent = document.getElementById('app-content');
        const mainNav = document.getElementById('main-nav');
        const navLinks = mainNav.querySelectorAll('.nav-link');

        // --- SVG Icons ---
        const ICONS = { /* ... (Icons remain the same, add history icon) ... */ edit: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>`, delete: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>`, check: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>`, undo: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3" /></svg>`, save: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75 l6 6 9-13.5" /></svg>`, cancel: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>`, pin: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75m9 0H18A2.25 2.25 0 0 1 20.25 6v12A2.25 2.25 0 0 1 18 20.25H6A2.25 2.25 0 0 1 3.75 18V6A2.25 2.25 0 0 1 6 3.75h1.5m9 0h-9" /></svg>`, pin_filled: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M16.5 3.75a.75.75 0 0 1 .75.75v11.19l-4.72-2.36a.75.75 0 0 0-.56 0L7.5 15.69V4.5a.75.75 0 0 1 .75-.75h7.5Z" clip-rule="evenodd" /><path d="M18 3.75a2.25 2.25 0 0 1 2.25 2.25v12a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6A2.25 2.25 0 0 1 6 3.75h12Z" /></svg>`, history: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>`, fire: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M8.75 1.75a.75.75 0 0 0-1.5 0v1.313c-.37-.1-.76-.163-1.17-.198C4.895 2.798 4 3.65 4 4.857c0 .41.13 1.03.393 1.776.24.69.662 1.42 1.28 2.065.617.645 1.333 1.176 2.146 1.571a.75.75 0 0 0 .44-.073c.813-.395 1.53- .926 2.147-1.57.618-.646 1.04-1.376 1.28-2.066C11.87 5.888 12 5.267 12 4.857c0-1.206-.895-2.059-2.08-2.186-.41-.035-.8-.1-1.17-.198V1.75Z" /><path d="M4.708 11.584a.75.75 0 0 1 .875.016C6.333 12.06 7.167 12.5 8 12.5s1.667-.44 2.417-.9a.75.75 0 0 1 .875-.016 14.41 14.41 0 0 1 1.145.61c.217.12.4.27.548.454a.75.75 0 0 1-.918 1.183 12.905 12.905 0 0 0-2.54-.714c-.427-.089-.86-.133-1.296-.133s-.87.044-1.297.133a12.904 12.904 0 0 0-2.54.714.75.75 0 0 1-.918-1.183c.148-.184.33-.334.548-.454a14.411 14.411 0 0 1 1.145-.61Z" /></svg>` };

        // --- Module Building Functions ---
        function buildNotesUI() { /* ... (no changes) ... */ if(!appContent.classList.contains('app-module-container')){appContent.className='app-module-container';} appContent.innerHTML=`<h2 class="text-xl font-semibold mb-4">Ghi Chú Nhanh</h2><div class="mb-4"><textarea id="note-input" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="4" placeholder="Nhập ghi chú..."></textarea></div><button id="add-note-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 ease-in-out mb-6">Thêm Ghi Chú</button><div class="mb-4"><input type="search" id="search-input" placeholder="Tìm kiếm ghi chú..." class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></div><div id="notes-list" class="mt-6 space-y-3"></div>`; const ni=document.getElementById('note-input'); const ab=document.getElementById('add-note-btn'); const si=document.getElementById('search-input'); const nl=document.getElementById('notes-list'); ab.addEventListener('click',()=>addNote(ni,si)); ni.addEventListener('keydown',(e)=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();addNote(ni,si);}}); si.addEventListener('input',(e)=>displayNotes(nl,si,e.target.value)); displayNotes(nl,si); }
        function buildGoalsUI() { /* ... (no changes) ... */ if(!appContent.classList.contains('app-module-container')){appContent.className='app-module-container';} appContent.innerHTML=`<h2 class="text-xl font-semibold mb-4">Theo dõi Mục tiêu</h2><form id="add-goal-form" class="mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50 space-y-3"><div><label for="goal-input" class="block text-sm font-medium text-gray-700 mb-1">Tên mục tiêu:</label><input type="text" id="goal-input" placeholder="Ví dụ: Học JavaScript nâng cao" required class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></div><div><label for="goal-desc-input" class="block text-sm font-medium text-gray-700 mb-1">Mô tả (tùy chọn):</label><textarea id="goal-desc-input" placeholder="Mô tả chi tiết các bước hoặc lý do..." rows="3" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea></div><div><label for="goal-due-date-input" class="block text-sm font-medium text-gray-700 mb-1">Hạn chót (tùy chọn):</label><input type="date" id="goal-due-date-input" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></div><button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 ease-in-out w-full sm:w-auto">Thêm Mục tiêu</button></form><h3 class="text-lg font-semibold mb-3 text-gray-700">Danh sách Mục tiêu</h3><div id="goals-list" class="space-y-3"></div>`; const agf=document.getElementById('add-goal-form'); const gi=document.getElementById('goal-input'); const gdi=document.getElementById('goal-desc-input'); const gddi=document.getElementById('goal-due-date-input'); const gl=document.getElementById('goals-list'); agf.addEventListener('submit',(e)=>{e.preventDefault();addGoal(gi,gdi,gddi,gl);}); displayGoals(gl); }
        function buildHabitsUI() { /* ... (no changes in structure) ... */ if(!appContent.classList.contains('app-module-container')){appContent.className='app-module-container';} appContent.innerHTML=`<h2 class="text-xl font-semibold mb-4">Theo dõi Thói quen</h2><form id="add-habit-form" class="mb-6 flex items-center space-x-2"><input type="text" id="habit-input" placeholder="Nhập thói quen mới (ví dụ: Đọc sách 30 phút)" required class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"><button type="submit" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 ease-in-out">Thêm Thói quen</button></form><h3 class="text-lg font-semibold mb-3 text-gray-700">Thói quen Hôm nay (${getTodayDateString()})</h3><div id="habits-list" class="space-y-2"></div>`; const ahf=document.getElementById('add-habit-form'); const hi=document.getElementById('habit-input'); const hl=document.getElementById('habits-list'); ahf.addEventListener('submit',(e)=>{e.preventDefault();addHabit(hi,hl);}); displayHabits(hl); }

        // --- Core Application Logic ---
        function renderAppContent() { /* ... (no changes) ... */ console.log(`Rendering module: ${currentModule}`); let t="Ứng dụng Cá nhân"; if(currentModule==='notes')t+=" - Ghi Chú"; else if(currentModule==='goals')t+=" - Mục tiêu"; else if(currentModule==='habits')t+=" - Thói quen"; document.title=t; navLinks.forEach(l=>{l.classList.toggle('active',l.dataset.module===currentModule);}); appContent.innerHTML=`<p class="empty-state-message">Đang tải ${currentModule}...</p>`; setTimeout(()=>{switch(currentModule){case 'notes':buildNotesUI();break;case 'goals':buildGoalsUI();break;case 'habits':buildHabitsUI();break;default:appContent.innerHTML='<p class="empty-state-message">Module không xác định.</p>';}},0); }

        // --- Note Management Functions ---
        function getNotes() { /* ... (no changes) ... */ const n=localStorage.getItem('quickNotes'); try { const p=n?JSON.parse(n):[]; return p.map(no=>({...no, isPinned: no.isPinned || false })); } catch(e){console.error("Error parsing notes:",e); return [];} }
        function saveNotes(notes) { /* ... (no changes) ... */ localStorage.setItem('quickNotes',JSON.stringify(notes)); }
        function formatTimestamp(timestamp) { /* ... (no changes) ... */ if(!timestamp)return ''; const d=new Date(timestamp); return `${d.toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'})}, ${d.toLocaleDateString('vi-VN',{day:'2-digit',month:'2-digit',year:'numeric'})}`; }
        function displayNotes(listEl, searchEl, term='') { /* ... (no changes) ... */ if(!listEl||!searchEl){return;} let n=getNotes(); const s=term.toLowerCase().trim(); if(s){n=n.filter(no=>no.content.toLowerCase().includes(s));} listEl.innerHTML=''; if(n.length===0){listEl.innerHTML=`<p class="empty-state-message">${s?'Không tìm thấy ghi chú nào khớp.':'Chưa có ghi chú nào.'}</p>`; return;} n.sort((a,b)=>(b.isPinned-a.isPinned)||(b.modifiedAt||b.createdAt)-(a.modifiedAt||a.createdAt)); n.forEach(no=>{const ne=document.createElement('div'); ne.dataset.noteId=no.id; ne.classList.add('note-item','list-item-hover','flex','flex-col'); if(no.isPinned){ne.classList.add('pinned');} if(no.isPinned){const pi=document.createElement('span'); pi.classList.add('pin-indicator'); pi.innerHTML=ICONS.pin_filled; ne.appendChild(pi);} const tr=document.createElement('div'); tr.classList.add('flex','justify-between','items-start','w-full'); const cc=document.createElement('div'); cc.classList.add('flex-grow','mr-2'); const ce=document.createElement('p'); ce.classList.add('note-content','text-gray-800'); ce.textContent=no.content; cc.appendChild(ce); const bc=document.createElement('div'); bc.classList.add('flex-shrink-0','flex','items-center'); const pb=document.createElement('button'); pb.classList.add('action-button-icon','pin-icon-btn'); if(no.isPinned){pb.classList.add('pinned'); pb.innerHTML=ICONS.pin_filled; pb.setAttribute('aria-label','Bỏ ghim ghi chú');} else {pb.innerHTML=ICONS.pin; pb.setAttribute('aria-label','Ghim ghi chú');} pb.onclick=()=>toggleNotePin(no.id,listEl,searchEl); const eb=document.createElement('button'); eb.classList.add('action-button-icon','edit-icon-btn'); eb.innerHTML=ICONS.edit; eb.setAttribute('aria-label','Sửa ghi chú'); eb.onclick=()=>toggleEdit(no.id,listEl,searchEl); const db=document.createElement('button'); db.classList.add('action-button-icon','delete-icon-btn'); db.innerHTML=ICONS.delete; db.setAttribute('aria-label','Xóa ghi chú'); db.onclick=()=>deleteNote(no.id,listEl,searchEl); bc.appendChild(pb); bc.appendChild(eb); bc.appendChild(db); tr.appendChild(cc); tr.appendChild(bc); const ts=document.createElement('p'); ts.classList.add('note-timestamp','w-full','text-right'); const cr=formatTimestamp(no.createdAt); const md=formatTimestamp(no.modifiedAt); ts.textContent=md?`Sửa đổi: ${md}`:(cr?`Đã tạo: ${cr}`:''); ne.appendChild(tr); if(ts.textContent){ne.appendChild(ts);} listEl.appendChild(ne);}); }
        function addNote(inputEl, searchEl) { /* ... (no changes) ... */ if(!inputEl||!searchEl)return; const c=inputEl.value.trim(); if(c){const n=getNotes(); const now=Date.now(); const nn={id:now, content:c, createdAt:now, modifiedAt:null, isPinned: false }; n.push(nn); saveNotes(n); inputEl.value=''; searchEl.value=''; const cl=document.getElementById('notes-list'); if(cl){displayNotes(cl,searchEl);}} }
        function deleteNote(id, listEl, searchEl) { /* ... (no changes) ... */ if(!window.confirm("Bạn chắc chắn xóa ghi chú này?"))return; let n=getNotes(); n=n.filter(no=>no.id!==id); saveNotes(n); displayNotes(listEl,searchEl,searchEl.value); }
        function toggleEdit(id, listEl, searchEl) { /* ... (no changes) ... */ displayNotes(listEl,searchEl,searchEl.value); const el=listEl.querySelector(`[data-note-id='${id}']`); if(!el)return; const tr=el.querySelector('div:first-child'); const cc=tr.querySelector('div:first-child'); const bc=tr.querySelector('div:last-child'); const n=getNotes(); const no=n.find(i=>i.id===id); if(!no)return; cc.innerHTML=''; bc.innerHTML=''; const ei=document.createElement('textarea'); ei.classList.add('w-full','p-1','border','border-gray-300','rounded-md','focus:outline-none','focus:ring-1','focus:ring-blue-500','edit-textarea','note-content'); ei.value=no.content; cc.appendChild(ei); const sb=document.createElement('button'); sb.classList.add('action-button-icon','save-icon-btn'); sb.innerHTML=ICONS.save; sb.setAttribute('aria-label','Lưu thay đổi'); sb.onclick=()=>saveEdit(id,ei.value,listEl,searchEl); const cb=document.createElement('button'); cb.classList.add('action-button-icon','cancel-icon-btn'); cb.innerHTML=ICONS.cancel; cb.setAttribute('aria-label','Hủy bỏ'); cb.onclick=()=>displayNotes(listEl,searchEl,searchEl.value); bc.appendChild(sb); bc.appendChild(cb); el.classList.add('editing'); ei.focus(); }
        function saveEdit(id, content, listEl, searchEl) { /* ... (no changes) ... */ const tc=content.trim(); if(!tc){displayNotes(listEl,searchEl,searchEl.value); return;} let n=getNotes(); const idx=n.findIndex(no=>no.id===id); if(idx>-1){n[idx].content=tc; n[idx].modifiedAt=Date.now(); saveNotes(n); displayNotes(listEl,searchEl,searchEl.value);} else {console.error("Cannot find note to save:",id); displayNotes(listEl,searchEl,searchEl.value);} }
        function toggleNotePin(noteId, listEl, searchEl) { /* ... (no changes) ... */ let n=getNotes(); const i=n.findIndex(no=>no.id===noteId); if(i>-1){n[i].isPinned=!n[i].isPinned; n[i].modifiedAt=Date.now(); saveNotes(n); displayNotes(listEl,searchEl,searchEl.value); console.log(`Toggled pin note: ${noteId} to ${n[i].isPinned}`);} else {console.error("Cannot find note to pin:",noteId);} }

        // --- Goal Management Functions ---
        const GOALS_STORAGE_KEY = 'personalGoals';
        function getGoals() { /* ... (no changes) ... */ const g=localStorage.getItem(GOALS_STORAGE_KEY); try { const p=g?JSON.parse(g):[]; return p.map(go=>({...go, isPinned: go.isPinned || false })); } catch(e){console.error("Error parsing goals:",e); return [];} }
        function saveGoals(goals) { /* ... (no changes) ... */ localStorage.setItem(GOALS_STORAGE_KEY,JSON.stringify(goals)); }
        function formatDisplayDate(dateString) { /* ... (no changes) ... */ if(!dateString)return ''; try{const [y,m,d]=dateString.split('-'); return `${d}/${m}/${y}`;} catch(e){console.error("Error formatting date:",e); return dateString;} }
        function calculateDaysRemaining(dueDateString) { /* ... (no changes) ... */ if (!dueDateString) return { text: '', class: '' }; try { const t=new Date(); t.setHours(0,0,0,0); const d=new Date(dueDateString); d.setHours(0,0,0,0); const diffTime=d.getTime()-t.getTime(); const diffDays=Math.ceil(diffTime/(1000*60*60*24)); if(diffDays<0){return { text:`Quá hạn ${Math.abs(diffDays)} ngày`, class:'overdue'};} else if(diffDays===0){return { text:'Hết hạn hôm nay', class:'due-soon'};} else if(diffDays<=7){return { text:`Còn ${diffDays} ngày`, class:'due-soon'};} else {return { text:`Còn ${diffDays} ngày`, class:'on-track'};} } catch(e){console.error("Error calculating days remaining:",e); return { text:'', class:''};} }
        function displayGoals(goalsListElement) { /* ... (no changes) ... */ if(!goalsListElement){console.error("Goals list element needed");return;} const g=getGoals(); goalsListElement.innerHTML=''; if(g.length===0){goalsListElement.innerHTML='<p class="empty-state-message">Chưa có mục tiêu nào.</p>';return;} g.sort((a,b)=>(b.isPinned-a.isPinned)||(a.completed-b.completed)||(new Date(a.dueDate||'9999-12-31')-new Date(b.dueDate||'9999-12-31'))||(b.createdAt-a.createdAt)); g.forEach(go=>{const ge=document.createElement('div'); ge.dataset.goalId=go.id; ge.classList.add('goal-item','list-item-hover'); if(go.completed)ge.classList.add('completed'); if(go.isPinned)ge.classList.add('pinned'); if(go.isPinned){const pi=document.createElement('span'); pi.classList.add('pin-indicator'); pi.style.color='#4f46e5'; pi.innerHTML=ICONS.pin_filled; ge.appendChild(pi);} const gh=document.createElement('div'); gh.classList.add('goal-header'); const ne=document.createElement('span'); ne.classList.add('goal-name'); ne.textContent=go.name; const bc=document.createElement('div'); bc.classList.add('flex-shrink-0','flex','items-center'); const pb=document.createElement('button'); pb.classList.add('action-button-icon','pin-icon-btn'); if(go.isPinned){pb.classList.add('pinned'); pb.innerHTML=ICONS.pin_filled; pb.setAttribute('aria-label','Bỏ ghim mục tiêu');} else {pb.innerHTML=ICONS.pin; pb.setAttribute('aria-label','Ghim mục tiêu');} pb.onclick=()=>toggleGoalPin(go.id,goalsListElement); const eb=document.createElement('button'); eb.classList.add('action-button-icon','edit-icon-btn'); eb.innerHTML=ICONS.edit; eb.setAttribute('aria-label','Sửa mục tiêu'); eb.onclick=()=>toggleGoalEdit(go.id,goalsListElement); const cb=document.createElement('button'); cb.classList.add('action-button-icon'); if(go.completed){cb.classList.add('undo-icon-btn'); cb.innerHTML=ICONS.undo; cb.setAttribute('aria-label','Đánh dấu chưa hoàn thành');} else {cb.classList.add('complete-icon-btn'); cb.innerHTML=ICONS.check; cb.setAttribute('aria-label','Đánh dấu hoàn thành');} cb.onclick=()=>toggleGoalComplete(go.id,goalsListElement); const db=document.createElement('button'); db.classList.add('action-button-icon','delete-icon-btn'); db.innerHTML=ICONS.delete; db.setAttribute('aria-label','Xóa mục tiêu'); db.onclick=()=>deleteGoal(go.id,goalsListElement); bc.appendChild(pb); bc.appendChild(eb); bc.appendChild(cb); bc.appendChild(db); gh.appendChild(ne); gh.appendChild(bc); const gd=document.createElement('div'); gd.classList.add('goal-details'); if(go.description){const d=document.createElement('p'); d.classList.add('goal-description'); d.textContent=go.description; gd.appendChild(d);} if(go.dueDate&&!go.completed){const di=document.createElement('div'); const r=calculateDaysRemaining(go.dueDate); di.classList.add('goal-due-date-info',r.class); const dt=document.createElement('span'); dt.classList.add('goal-due-date'); dt.textContent=`Hạn: ${formatDisplayDate(go.dueDate)}`; const rt=document.createElement('span'); rt.classList.add('goal-days-remaining'); rt.textContent=r.text; di.appendChild(dt); di.appendChild(rt); gd.appendChild(di);} else if(go.dueDate&&go.completed){const cd=document.createElement('p'); cd.classList.add('goal-due-date','text-gray-400'); cd.textContent=`(Hạn chót: ${formatDisplayDate(go.dueDate)})`; gd.appendChild(cd);} ge.appendChild(gh); if(gd.hasChildNodes()){ge.appendChild(gd);} goalsListElement.appendChild(ge);}); }
        function addGoal(nameInput, descInput, dueDateInput, goalsListElement) { /* ... (no changes) ... */ if (!nameInput||!descInput||!dueDateInput||!goalsListElement) return; const gn=nameInput.value.trim(); const gd=descInput.value.trim(); const gdd=dueDateInput.value; if(gn){const g=getGoals(); const n=Date.now(); const ng={id:n, name:gn, description:gd, dueDate:gdd||null, completed:false, createdAt:n, modifiedAt:null, isPinned: false }; g.push(ng); saveGoals(g); nameInput.value=''; descInput.value=''; dueDateInput.value=''; displayGoals(goalsListElement); console.log("Added goal:",ng);} else { console.log("Goal name empty."); alert("Tên mục tiêu không được để trống!"); } }
        function deleteGoal(goalId, goalsListElement) { /* ... (no changes) ... */ if (!window.confirm("Bạn có chắc muốn xóa mục tiêu này không?")) return; let g=getGoals(); g=g.filter(go=>go.id!==goalId); saveGoals(g); displayGoals(goalsListElement); console.log("Deleted goal ID:",goalId); }
        function toggleGoalComplete(goalId, goalsListElement) { /* ... (no changes) ... */ let g=getGoals(); const i=g.findIndex(go=>go.id===goalId); if(i>-1){g[i].completed=!g[i].completed; g[i].modifiedAt=Date.now(); saveGoals(g); displayGoals(goalsListElement); console.log(`Toggled completion: ${goalId} to ${g[i].completed}`);} else {console.error("Cannot find goal to toggle:",goalId);} }
        function toggleGoalEdit(goalId, goalsListElement) { /* ... (no changes) ... */ displayGoals(goalsListElement); const el=goalsListElement.querySelector(`[data-goal-id='${goalId}']`); if(!el)return; const g=getGoals(); const go=g.find(i=>i.id===goalId); if(!go)return; const ea=document.createElement('div'); ea.classList.add('goal-edit-area','mt-2','pt-2','border-t','border-gray-300'); const nl=document.createElement('label'); nl.textContent="Tên:"; nl.classList.add('block','text-xs','font-medium','text-gray-600','mb-1'); const ni=document.createElement('input'); ni.type='text'; ni.value=go.name; ni.required=true; ea.appendChild(nl); ea.appendChild(ni); const dl=document.createElement('label'); dl.textContent="Mô tả:"; dl.classList.add('block','text-xs','font-medium','text-gray-600','mb-1','mt-2'); const dt=document.createElement('textarea'); dt.rows='3'; dt.value=go.description||''; ea.appendChild(dl); ea.appendChild(dt); const ddl=document.createElement('label'); ddl.textContent="Hạn chót:"; ddl.classList.add('block','text-xs','font-medium','text-gray-600','mb-1','mt-2'); const ddi=document.createElement('input'); ddi.type='date'; ddi.value=go.dueDate||''; ea.appendChild(ddl); ea.appendChild(ddi); const ebc=document.createElement('div'); ebc.classList.add('flex','justify-end','mt-3'); const sb=document.createElement('button'); sb.classList.add('action-button-icon','save-icon-btn'); sb.innerHTML=ICONS.save; sb.setAttribute('aria-label','Lưu thay đổi'); sb.onclick=()=>saveGoalEdit(goalId,ni.value,dt.value,ddi.value,goalsListElement); const cb=document.createElement('button'); cb.classList.add('action-button-icon','cancel-icon-btn'); cb.innerHTML=ICONS.cancel; cb.setAttribute('aria-label','Hủy bỏ'); cb.onclick=()=>displayGoals(goalsListElement); ebc.appendChild(sb); ebc.appendChild(cb); ea.appendChild(ebc); el.innerHTML=''; el.appendChild(ea); el.classList.add('editing'); ni.focus(); }
        function saveGoalEdit(goalId, newName, newDesc, newDueDate, goalsListElement) { /* ... (no changes) ... */ const tn=newName.trim(); if(!tn){alert("Tên mục tiêu không được để trống!"); return;} let g=getGoals(); const i=g.findIndex(go=>go.id===goalId); if(i>-1){g[i].name=tn; g[i].description=newDesc.trim(); g[i].dueDate=newDueDate||null; g[i].modifiedAt=Date.now(); saveGoals(g); displayGoals(goalsListElement); console.log("Saved edit for goal:",goalId);} else {console.error("Cannot find goal to save:",goalId); displayGoals(goalsListElement);} }
        function toggleGoalPin(goalId, goalsListElement) { /* ... (no changes) ... */ let g=getGoals(); const i=g.findIndex(go=>go.id===goalId); if(i>-1){g[i].isPinned=!g[i].isPinned; g[i].modifiedAt=Date.now(); saveGoals(g); displayGoals(goalsListElement); console.log(`Toggled pin goal: ${goalId} to ${g[i].isPinned}`);} else {console.error("Cannot find goal to pin:",goalId);} }


        // --- Habit Management Functions ---
        const HABITS_STORAGE_KEY = 'personalHabits';
        function getTodayDateString() { /* ... (no changes) ... */ const t=new Date(); const y=t.getFullYear(); const m=String(t.getMonth()+1).padStart(2,'0'); const d=String(t.getDate()).padStart(2,'0'); return `${y}-${m}-${d}`; }
        function getHabits() { /* ... (no changes) ... */ const h=localStorage.getItem(HABITS_STORAGE_KEY); try { const p=h?JSON.parse(h):[]; return p.map(ha=>({...ha, completedDates:Array.isArray(ha.completedDates)?ha.completedDates:[]})); } catch(e){console.error("Error parsing habits:",e); return [];} }
        function saveHabits(habits) { /* ... (no changes) ... */ localStorage.setItem(HABITS_STORAGE_KEY,JSON.stringify(habits)); }

        // *** NEW: Calculate Habit Streak ***
        function calculateCurrentStreak(completedDates) {
            if (!Array.isArray(completedDates) || completedDates.length === 0) {
                return 0;
            }
            // Sort dates descending to easily check consecutive days
            const sortedDates = completedDates.map(dateStr => new Date(dateStr)).sort((a, b) => b - a);

            let streak = 0;
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);

            // Check if the most recent completed date is today or yesterday
            if (sortedDates[0].getTime() === today.getTime() || sortedDates[0].getTime() === yesterday.getTime()) {
                streak = 1; // Start with 1 if today/yesterday is completed
                let currentExpectedDate = new Date(sortedDates[0]);

                for (let i = 1; i < sortedDates.length; i++) {
                    currentExpectedDate.setDate(currentExpectedDate.getDate() - 1); // Expect the previous day
                    if (sortedDates[i].getTime() === currentExpectedDate.getTime()) {
                        streak++; // Increment streak if the next date is consecutive
                    } else {
                        break; // Streak broken
                    }
                }
            }
            return streak;
        }

        // *** UPDATED: displayHabits Function ***
        function displayHabits(habitsListElement) {
            if (!habitsListElement) { console.error("Habits list element needed"); return; }
            const habits = getHabits();
            const todayStr = getTodayDateString();
            habitsListElement.innerHTML = '';

            if (habits.length === 0) { habitsListElement.innerHTML = '<p class="empty-state-message">Chưa có thói quen nào được tạo.</p>'; return; }

            habits.sort((a, b) => a.name.localeCompare(b.name));

            habits.forEach(habit => {
                const habitElement = document.createElement('div');
                habitElement.dataset.habitId = habit.id;
                habitElement.classList.add('habit-item', 'list-item-hover');

                // Container for name and streak
                const habitInfo = document.createElement('div');
                habitInfo.classList.add('habit-info');

                const nameElement = document.createElement('span');
                nameElement.classList.add('habit-name');
                nameElement.textContent = habit.name;
                habitInfo.appendChild(nameElement);

                // Calculate and display streak
                const currentStreak = calculateCurrentStreak(habit.completedDates);
                if (currentStreak > 0) {
                    const streakElement = document.createElement('span');
                    streakElement.classList.add('habit-streak');
                    streakElement.innerHTML = `${ICONS.fire} ${currentStreak}`; // Add fire icon
                    streakElement.title = `Chuỗi ${currentStreak} ngày liên tiếp!`; // Tooltip
                    habitInfo.appendChild(streakElement);
                }

                // --- Controls Container ---
                const controlsContainer = document.createElement('div');
                controlsContainer.classList.add('flex', 'items-center');

                // Checkbox
                const isCompletedToday = habit.completedDates.includes(todayStr);
                const checkboxId = `habit-check-${habit.id}`;
                const checkboxLabel = document.createElement('label'); checkboxLabel.htmlFor = checkboxId; checkboxLabel.classList.add('habit-checkbox-label'); if(isCompletedToday){checkboxLabel.classList.add('checked'); checkboxLabel.innerHTML=ICONS.check;}
                const checkbox = document.createElement('input'); checkbox.type='checkbox'; checkbox.id=checkboxId; checkbox.checked=isCompletedToday; checkbox.classList.add('habit-checkbox'); checkbox.onchange=()=>toggleHabitCompletion(habit.id,habitsListElement);

                // History Button
                const historyButton = document.createElement('button');
                historyButton.classList.add('action-button-icon', 'history-icon-btn');
                historyButton.innerHTML = ICONS.history;
                historyButton.setAttribute('aria-label', 'Xem lịch sử');
                historyButton.onclick = () => showHabitHistory(habit.id);

                // Delete Button
                const deleteButton = document.createElement('button'); deleteButton.classList.add('action-button-icon','delete-icon-btn'); deleteButton.innerHTML=ICONS.delete; deleteButton.setAttribute('aria-label','Xóa thói quen'); deleteButton.onclick=()=>deleteHabit(habit.id,habitsListElement);

                controlsContainer.appendChild(checkboxLabel);
                controlsContainer.appendChild(checkbox);
                controlsContainer.appendChild(historyButton); // Add history button
                controlsContainer.appendChild(deleteButton);

                habitElement.appendChild(habitInfo); // Use habitInfo container
                habitElement.appendChild(controlsContainer);
                habitsListElement.appendChild(habitElement);
            });
        }

        function addHabit(habitInputElement, habitsListElement) { /* ... (no changes) ... */ if(!habitInputElement||!habitsListElement)return; const hn=habitInputElement.value.trim(); if(hn){const h=getHabits(); if(h.some(ha=>ha.name.toLowerCase()===hn.toLowerCase())){alert(`Thói quen "${hn}" đã tồn tại!`); return;} const n=Date.now(); const nh={id:n, name:hn, createdAt:n, completedDates:[]}; h.push(nh); saveHabits(h); habitInputElement.value=''; displayHabits(habitsListElement); console.log("Added habit:",nh);} else {alert("Tên thói quen không được để trống!");} }
        function deleteHabit(habitId, habitsListElement) { /* ... (no changes) ... */ if(!window.confirm("Bạn có chắc muốn xóa thói quen này? Việc này cũng sẽ xóa lịch sử hoàn thành của nó."))return; let h=getHabits(); h=h.filter(ha=>ha.id!==habitId); saveHabits(h); displayHabits(habitsListElement); console.log("Deleted habit ID:",habitId); }
        function toggleHabitCompletion(habitId, habitsListElement) { /* ... (no changes) ... */ let h=getHabits(); const i=h.findIndex(ha=>ha.id===habitId); const t=getTodayDateString(); if(i>-1){const cd=h[i].completedDates; const di=cd.indexOf(t); if(di>-1){cd.splice(di,1); console.log(`Unmarked habit ${habitId} for ${t}`);} else {cd.push(t); console.log(`Marked habit ${habitId} for ${t}`);} saveHabits(h); displayHabits(habitsListElement);} else {console.error("Cannot find habit to toggle:",habitId);} }

        // *** NEW: Show Habit History (Console Log Version) ***
        function showHabitHistory(habitId) {
            const habits = getHabits();
            const habit = habits.find(h => h.id === habitId);
            if (habit) {
                console.log(`Lịch sử hoàn thành cho "${habit.name}" (ID: ${habitId}):`);
                if (habit.completedDates.length > 0) {
                    // Sort dates ascending for logging
                    const sortedDates = [...habit.completedDates].sort();
                    console.log(sortedDates);
                    alert(`Lịch sử hoàn thành cho "${habit.name}":\n${sortedDates.join('\n')}`); // Show basic alert
                } else {
                    console.log("Chưa hoàn thành ngày nào.");
                    alert(`Chưa hoàn thành ngày nào cho "${habit.name}".`);
                }
            } else {
                console.error("Không tìm thấy thói quen để xem lịch sử:", habitId);
            }
        }

        // --- Initialization and Event Listeners ---
        navLinks.forEach(link => { /* ... (no changes) ... */ link.addEventListener('click',(e)=>{e.preventDefault(); const sm=e.target.dataset.module; if(sm&&sm!==currentModule){currentModule=sm; renderAppContent();}}); });
        document.addEventListener('DOMContentLoaded', renderAppContent);
        console.log("Personal App with Habit Streak/History Added!");

    </script>

</body>
</html>
