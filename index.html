<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Phát triển Cá nhân - Ghi Chú</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .note-content, .edit-textarea {
            white-space: pre-wrap;
            word-break: break-word;
        }
        .edit-textarea {
            min-height: 60px;
        }
        .action-button {
            font-size: 0.875rem; /* text-sm */
            padding: 0.25rem 0.5rem; /* py-1 px-2 */
            margin-left: 0.5rem; /* ml-2 */
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out;
            font-weight: 500; /* medium */
        }
        .note-timestamp {
            font-size: 0.75rem; /* text-xs */
            color: #6b7280; /* text-gray-500 */
            margin-top: 0.5rem; /* mt-2 */
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">

    <header class="bg-blue-600 text-white p-4 shadow-md">
        <div class="container mx-auto">
            <h1 class="text-2xl font-bold">Ứng dụng Cá nhân Của Tôi</h1>
            </div>
    </header>

    <main class="container mx-auto p-4 mt-4">
        <div id="app-content" class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Ghi Chú Nhanh</h2>

            <div class="mb-4">
                <textarea id="note-input" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="4" placeholder="Nhập ghi chú của bạn ở đây..."></textarea>
            </div>
            <button id="add-note-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 ease-in-out mb-6">
                Thêm Ghi Chú
            </button>

            <div class="mb-4">
                <input type="search" id="search-input" placeholder="Tìm kiếm ghi chú..." class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div id="notes-list" class="mt-6 space-y-3">
                </div>
        </div>
    </main>

    <footer class="text-center text-gray-500 mt-8 p-4">
        <p>&copy; 2025 - Tạo bởi Bạn & Gemini</p>
    </footer>

    <script>
        const noteInput = document.getElementById('note-input');
        const addNoteBtn = document.getElementById('add-note-btn');
        const notesList = document.getElementById('notes-list');
        const searchInput = document.getElementById('search-input'); // Get search input element

        // --- Note Management ---

        function getNotes() {
            const notes = localStorage.getItem('quickNotes');
            // Parse notes, ensure createdAt/modifiedAt are Date objects if they exist
            try {
                const parsedNotes = notes ? JSON.parse(notes) : [];
                return parsedNotes.map(note => ({
                    ...note,
                    // Convert timestamp strings back to Date objects if needed (optional but good practice)
                    // createdAt: note.createdAt ? new Date(note.createdAt) : undefined,
                    // modifiedAt: note.modifiedAt ? new Date(note.modifiedAt) : undefined,
                }));
            } catch (e) {
                console.error("Error parsing notes from localStorage:", e);
                return []; // Return empty array on error
            }
        }

        function saveNotes(notes) {
            // Ensure timestamps are stored as ISO strings for consistency
            const notesToSave = notes.map(note => ({
                ...note,
                // createdAt: note.createdAt instanceof Date ? note.createdAt.toISOString() : note.createdAt,
                // modifiedAt: note.modifiedAt instanceof Date ? note.modifiedAt.toISOString() : note.modifiedAt,
            }));
            localStorage.setItem('quickNotes', JSON.stringify(notesToSave));
        }

        // Function to format timestamp for display
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            // Example format: 14:30, 04/05/2025
            return `${date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })}, ${date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
        }

        // Modified displayNotes to accept a search term
        function displayNotes(searchTerm = '') {
            let notes = getNotes();
            const normalizedSearchTerm = searchTerm.toLowerCase().trim();

            // Filter notes based on search term
            if (normalizedSearchTerm) {
                notes = notes.filter(note =>
                    note.content.toLowerCase().includes(normalizedSearchTerm)
                );
            }

            notesList.innerHTML = ''; // Clear current list

            if (notes.length === 0) {
                notesList.innerHTML = `<p class="text-gray-500">${normalizedSearchTerm ? 'Không tìm thấy ghi chú nào khớp.' : 'Chưa có ghi chú nào.'}</p>`;
                return;
            }

            // Sort by modifiedAt or createdAt (newest first)
            notes.sort((a, b) => (b.modifiedAt || b.createdAt) - (a.modifiedAt || a.createdAt));

            notes.forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.dataset.noteId = note.id;
                noteElement.classList.add('bg-yellow-100', 'p-3', 'rounded-md', 'shadow-sm', 'flex', 'flex-col'); // Use flex-col for timestamp

                // Top row: Content and Buttons
                const topRow = document.createElement('div');
                topRow.classList.add('flex', 'justify-between', 'items-start', 'w-full');

                const contentContainer = document.createElement('div');
                contentContainer.classList.add('flex-grow', 'mr-2'); // Content area

                const contentElement = document.createElement('p');
                contentElement.classList.add('note-content', 'text-gray-700');
                contentElement.textContent = note.content;
                contentContainer.appendChild(contentElement);

                const buttonContainer = document.createElement('div');
                buttonContainer.classList.add('flex-shrink-0', 'flex'); // Buttons area

                // Edit Button
                const editButton = document.createElement('button');
                editButton.classList.add('text-blue-600', 'hover:text-blue-800', 'action-button');
                editButton.textContent = 'Sửa';
                editButton.onclick = () => toggleEdit(note.id);

                // Delete Button
                const deleteButton = document.createElement('button');
                deleteButton.classList.add('text-red-500', 'hover:text-red-700', 'action-button');
                deleteButton.textContent = 'Xóa';
                deleteButton.onclick = () => deleteNote(note.id);

                buttonContainer.appendChild(editButton);
                buttonContainer.appendChild(deleteButton);

                topRow.appendChild(contentContainer);
                topRow.appendChild(buttonContainer);

                // Bottom row: Timestamp
                const timestampElement = document.createElement('p');
                timestampElement.classList.add('note-timestamp', 'w-full', 'text-right'); // Align timestamp to the right
                const created = formatTimestamp(note.createdAt);
                const modified = formatTimestamp(note.modifiedAt);
                // Show "Sửa đổi" if available, otherwise "Đã tạo"
                timestampElement.textContent = modified ? `Sửa đổi: ${modified}` : (created ? `Đã tạo: ${created}` : '');

                noteElement.appendChild(topRow);
                if (timestampElement.textContent) { // Only add timestamp if it exists
                    noteElement.appendChild(timestampElement);
                }
                notesList.appendChild(noteElement);
            });
        }

        function addNote() {
            const noteContent = noteInput.value.trim();
            if (noteContent) {
                const notes = getNotes();
                const now = Date.now(); // Get current timestamp
                const newNote = {
                    id: now, // Use timestamp as ID
                    content: noteContent,
                    createdAt: now, // Add creation timestamp
                    modifiedAt: null // No modification yet
                };
                notes.push(newNote);
                saveNotes(notes);
                noteInput.value = '';
                searchInput.value = ''; // Clear search when adding new note
                displayNotes(); // Refresh display
                console.log("Added note:", newNote);
            } else {
                console.log("Note content is empty.");
            }
        }

        function deleteNote(noteId) {
            // Add confirmation dialog
            if (!window.confirm("Bạn có chắc muốn xóa ghi chú này không?")) {
                return; // Stop if user cancels
            }

            let notes = getNotes();
            notes = notes.filter(note => note.id !== noteId);
            saveNotes(notes);
            // Refresh display using the current search term
            displayNotes(searchInput.value);
            console.log("Deleted note ID:", noteId);
        }

        function toggleEdit(noteId) {
            // Refresh the list with the current search term to cancel other edits
            displayNotes(searchInput.value);

            const noteElement = notesList.querySelector(`[data-note-id='${noteId}']`);
            if (!noteElement) return; // Element might be hidden by search

            const topRow = noteElement.querySelector('div:first-child'); // Top row contains content and buttons
            const contentContainer = topRow.querySelector('div:first-child');
            const buttonContainer = topRow.querySelector('div:last-child');
            const notes = getNotes();
            const note = notes.find(n => n.id === noteId);

            if (!note) return;

            // Create textarea for editing
            const editInput = document.createElement('textarea');
            editInput.classList.add('w-full', 'p-1', 'border', 'border-gray-300', 'rounded-md', 'focus:outline-none', 'focus:ring-1', 'focus:ring-blue-500', 'edit-textarea', 'note-content');
            editInput.value = note.content;

            // Create Save button
            const saveButton = document.createElement('button');
            saveButton.classList.add('text-green-600', 'hover:text-green-800', 'action-button');
            saveButton.textContent = 'Lưu';
            saveButton.onclick = () => saveEdit(noteId, editInput.value);

            // Create Cancel button
            const cancelButton = document.createElement('button');
            cancelButton.classList.add('text-gray-600', 'hover:text-gray-800', 'action-button');
            cancelButton.textContent = 'Hủy';
            // Cancel reverts by re-displaying with current search term
            cancelButton.onclick = () => displayNotes(searchInput.value);

            // Replace content and buttons
            contentContainer.innerHTML = '';
            contentContainer.appendChild(editInput);

            buttonContainer.innerHTML = '';
            buttonContainer.appendChild(saveButton);
            buttonContainer.appendChild(cancelButton);

            noteElement.classList.add('editing');
            editInput.focus();
        }

        function saveEdit(noteId, newContent) {
            const trimmedContent = newContent.trim();
            if (!trimmedContent) {
                console.log("Note content cannot be empty after edit.");
                // Optionally show error or delete if empty
                displayNotes(searchInput.value); // Revert on empty save
                return;
            }

            let notes = getNotes();
            const noteIndex = notes.findIndex(note => note.id === noteId);

            if (noteIndex > -1) {
                notes[noteIndex].content = trimmedContent;
                notes[noteIndex].modifiedAt = Date.now(); // Update modification timestamp
                saveNotes(notes);
                // Refresh display using the current search term
                displayNotes(searchInput.value);
                console.log("Saved edit for note ID:", noteId);
            } else {
                console.error("Could not find note to save:", noteId);
                displayNotes(searchInput.value);
            }
        }


        // --- Initialization and Event Listeners ---

        addNoteBtn.addEventListener('click', addNote);

        noteInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                addNote();
            }
        });

        // Add event listener for the search input
        searchInput.addEventListener('input', (event) => {
            // Call displayNotes with the current search value whenever input changes
            displayNotes(event.target.value);
        });

        // Initial display of notes on page load
        document.addEventListener('DOMContentLoaded', () => displayNotes());

        console.log("Quick Notes App (with Timestamp, Search, Confirm Delete) is ready!");

    </script>

</body>
</html>
